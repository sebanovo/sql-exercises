CREATE DATABASE MECANICA;
USE MECANICA;

CREATE TABLE VEHICULO
(
  PLACA VARCHAR(6) NOT NULL PRIMARY KEY,
  MARCA VARCHAR(50) NOT NULL,
  MODELO VARCHAR(10) NOT NULL,
  AÑO YEAR NOT NULL
);

CREATE TABLE ACCESORIO 
(
  CODIGO VARCHAR(4) NOT NULL PRIMARY KEY,
  NOMBRE VARCHAR(50) NOT NULL
);

CREATE TABLE PERSONA
(
  CI INTEGER NOT NULL PRIMARY KEY,
  NOMBRE VARCHAR(50) NOT NULL,
  TELEFONO INTEGER NOT NULL,
  DIRECCION VARCHAR(100),
  EMPRESA VARCHAR(50) ,
  CARGO VARCHAR(50) ,
  TIPOC BOOLEAN NOT NULL,
  TIPOE BOOLEAN NOT NULL
);

CREATE TABLE FORMULARIORECEPCION
(
  NRO INTEGER NOT NULL PRIMARY KEY,
  FECHA DATE NOT NULL,
  HORA TIME,
  CICLIENTE INTEGER NOT NULL,
  CIEMPLEADO INTEGER NOT NULL,
  PLACA VARCHAR(6) NOT NULL NOT NULL,
  FOREIGN KEY (CICLIENTE)
    REFERENCES PERSONA(CI)
    ON UPDATE CASCADE
    ON DELETE CASCADE,
  FOREIGN KEY (CIEMPLEADO) 
    REFERENCES PERSONA(CI)
    ON UPDATE CASCADE
    ON DELETE CASCADE,
  FOREIGN KEY (PLACA) 
    REFERENCES VEHICULO(PLACA)
    ON UPDATE CASCADE
    ON DELETE CASCADE
);

CREATE TABLE DETALLEACCESORIO
(
  NRO INTEGER NOT NULL,
  ID INTEGER NOT NULL,
  PRIMARY KEY (NRO, ID),
  ESTADO VARCHAR(50) NOT NULL,
  CODIGOACC VARCHAR(4) NOT NULL,
  FOREIGN KEY (NRO) 
    REFERENCES FORMULARIORECEPCION(NRO)
    ON UPDATE CASCADE
    ON DELETE CASCADE,
  FOREIGN KEY (CODIGOACC)
    REFERENCES ACCESORIO(CODIGO)
    ON UPDATE CASCADE
    ON DELETE CASCADE
);

INSERT INTO VEHICULO (PLACA, MARCA, MODELO, AÑO) VALUES 
('SWC300',	'TOYOTA',	'STARLET',	2000),
('YUP202',	'NISSAN',	'PRADO',	2020),
('PKU101',	'TOYOTA',	'SPACIO',	2010);

INSERT INTO ACCESORIO (CODIGO, NOMBRE) VALUES 
('A001',	'LLANTA AUXILIO'),
('A004',	'RADIO MP3'),
('A005',	'INFLADOR');

INSERT INTO PERSONA (CI, NOMBRE, TELEFONO, DIRECCION, EMPRESA, CARGO, TIPOC, TIPOE) VALUES 
(123,	'JOAQUIN CHUMACERO',	7102030	,'CALLE LANDIVAR 30',	'GASCO',	NULL,	TRUE,	FALSE),
(235,	'SATURNINO MAMANI',	7298302	, NULL, NULL,		'ADMINISTRATIVO',	FALSE,	TRUE),
(444,	'PATRICIA AGUILERA',	7163737	,'URB. LOS PENOCOS',	'TECNO', NULL,		TRUE,	FALSE),
(555,	'CARLOS CRESPO',	7272722,	NULL, NULL,		'RECEPCIONISTA', FALSE,	TRUE);

INSERT INTO FORMULARIORECEPCION (NRO, FECHA, HORA, CICLIENTE, CIEMPLEADO, PLACA) VALUES
(100,	'2025-01-10',	'10:00',	123,	235,	'SWC300'),
(101,	'2025-01-15',	'12:00',	444,	235,	'YUP202'),
(102,	'2025-01-15',	'12:00',	123,	555,	'SWC300'),
(103,	'2025-01-15',	'14:00',	123,	235,	'PKU101');

INSERT INTO DETALLEACCESORIO (NRO, ID, ESTADO, CODIGOACC) VALUES
(100,	1,	'BUEN ESTADO',	'A001'),
(100,	2,	'BUEN ESTADO',	'A004'),
(100,	3,	'MAL ESTADO',	'A001'),
(101,	1,	'BUEN ESTADO',	'A005'),
(101,	2,	'BUEN ESTADO',	'A001'),
(102,	1,	'BUEN ESTADO',	'A001'),
(103,	1,	'MAL ESTADO',	'A005'),
(103,	2,	'BUEN ESTADO',	'A001');

/*
CONSULTA: En base a la base de datos MECANICA Mostrar el nombre de los 
clientes que han dejado más de 1 accesorio con el nombre de llanta de auxilio.
*/
SELECT PERSONA.CI, PERSONA.NOMBRE, COUNT(FORMULARIORECEPCION.CICLIENTE) AS CANTIDAD_DE_ACCESORIO
FROM PERSONA, FORMULARIORECEPCION, DETALLEACCESORIO, ACCESORIO
WHERE PERSONA.CI = FORMULARIORECEPCION.CICLIENTE
AND DETALLEACCESORIO.NRO = FORMULARIORECEPCION.NRO
AND DETALLEACCESORIO.CODIGOACC = ACCESORIO.CODIGO
AND ACCESORIO.NOMBRE = 'LLANTA AUXILIO'
AND PERSONA.TIPOC = TRUE -- VERDADERO
GROUP BY FORMULARIORECEPCION.CICLIENTE
HAVING COUNT(FORMULARIORECEPCION.CICLIENTE) > 1;

/*
CONSULTA: En base a la base de datos MECANICA, Mostrar por cada vehiculo, cuantas
veces ha realizado mantenimiento
*/
SELECT VEHICULO.PLACA, VEHICULO.MARCA, VEHICULO.MODELO, COUNT(FORMULARIORECEPCION.PLACA) AS CANTIDAD_DE_MANTENIMIENTO
FROM FORMULARIORECEPCION, VEHICULO
WHERE FORMULARIORECEPCION.PLACA = VEHICULO.PLACA
GROUP BY FORMULARIORECEPCION.PLACA;
