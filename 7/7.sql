CREATE DATABASE FARMACIASA;
USE FARMACIASA;

CREATE TABLE CLIENTE
(
	CI INTEGER NOT NULL PRIMARY KEY,
    NOMBRE VARCHAR(35) NOT NULL,
    TELEFONO INTEGER NOT NULL
);

INSERT INTO CLIENTE (CI, NOMBRE, TELEFONO) VALUES 
(123456, 'Juan Perez', 7654321),
(765432, 'María Flores', 7123456),
(234576, 'Carlos Rojas', 7890123),
(982378, 'Saturnino Mamani', 6218931),
(328130, 'Jose Chumacero', 7832192),
(478218, 'Lucia Vargas', 7112233),
(671872, 'Marco Torres', 7567892),
(298391, 'Esteban Gutierrez', 7788992);

SELECT * FROM CLIENTE;

CREATE TABLE CATEGORIA
(
	ID INTEGER NOT NULL PRIMARY KEY,
    NOMBRE VARCHAR(40) NOT NULL,
    IDCAT INTEGER, 
	FOREIGN KEY (IDCAT)
	REFERENCES CATEGORIA(ID)
		ON UPDATE CASCADE
		ON DELETE CASCADE
);


INSERT INTO CATEGORIA (ID, NOMBRE, iDCAT) VALUES
(1, 'Analgésicos', NULL),
(2, 'Tabletas Analgésicas', 1),
(3, 'Cremas Analgésicas', 1),
(4, 'Antibióticos', NULL),
(5, 'Tabletas Antibióticas', 4),
(6, 'Jarabes Antibióticos', 4),
(7, 'Vitaminas & Suplementos', NULL),
(8, 'Multivitamínicos', 7),
(9, 'Vitaminas infantiles', 7),
(10, 'Suplementos Naturales', 7),
(11, 'Efervescentes', 7),
(12, 'Cuidado Personal', NULL),
(13, 'Higiene Personal', 12),
(14, 'Cuidado Capilar', 12),
(15, 'Infantes', NULL),
(16, 'Alimentación Infantil', 15),
(17, 'Accesorios', 15),
(18, 'Instrumentos Médicos', NULL),
(19, 'Medición', 18),
(20, 'Material descartable', 18);

SELECT * FROM CATEGORIA;

CREATE TABLE PRODUCTO
(
	CODIGO VARCHAR(4) NOT NULL PRIMARY KEY,
    NOMBRE VARCHAR(40) NOT NULL,
    PRECIO FLOAT NOT NULL,
    IDCAT INTEGER NOT NULL,
    FOREIGN KEY(IDCAT) 
    REFERENCES CATEGORIA(ID)
		ON DELETE CASCADE
        ON UPDATE CASCADE
);

INSERT INTO PRODUCTO (CODIGO, NOMBRE, PRECIO, IDCAT) VALUES
('A001', 'Paracetamol 500mg', 2, 1),
('A002', 'Ibuprofeno 400mg', 3, 1),
('A003', 'Tapsin Compuesto', 5, 1),
('A004', 'Dolorsan', 11, 1),
('A005', 'Voltadol', 42, 1),
('A006', 'Dolorub', 51, 1),
('B001', 'Amoxicilina 500mg', 1.5, 4),
('B002', 'Azitromicina 500mg', 11.5, 4),
('B003', 'Antifludes Capsula', 4.5, 4),
('B004', 'Cefalexina 15%', 54, 4),
('B005', 'Otoprin', 42, 4),
('B006', 'Azimut 200mg/5ml', 183, 4),
('C001', 'Gumys Vitamina C', 14, 7),
('C002', 'Biozone S', 89, 7),
('C003', 'Probiotic Fiber', 162, 7),
('C004', 'Defendyl', 10, 7),
('D001', 'Talco', 66, 12),
('D002', 'Cepillo Colgate', 9, 12),
('D003', 'Pasta Dental Colgate', 15, 12),
('D004', 'Shampoo Dove', 39, 12),
('E001', 'Cerelac 400g', 75.5, 13),
('E002', 'Leche en Polvo', 60, 13),
('E003', 'Nido Crecimiento', 158.8, 13),
('F001', 'Jeringa 1ml', 4, 18),
('F002', 'Barbijo', 0.6, 18),
('F003', 'Guantes de Latex', 0.7, 18);

SELECT * FROM PRODUCTO;

CREATE TABLE FACTURA
(
	NRO INTEGER NOT NULL PRIMARY KEY,
    FECHA DATE NOT NULL,
    NIT INTEGER,
    NOMBRE VARCHAR(40),
    CICLIENTE INTEGER NOT NULL,
    FOREIGN KEY(CICLIENTE) 
    REFERENCES CLIENTE(CI)
		ON DELETE CASCADE
        ON UPDATE CASCADE
);

INSERT INTO FACTURA (NRO, FECHA, NIT, NOMBRE, CICLIENTE) VALUES
(101, '2025-05-15', 123456, 'Juan Perez', 123456),
(102, '2025-05-15', 765432, 'María Flores', 765432),
(103, '2025-05-16', 982378, 'Saturnino Mamani', 982378),
(104, '2025-05-16', 478218, 'Lucia Vargas', 478218),
(105, '2025-05-16', 478218, 'Lucia Vargas', 478218),
(106, '2025-05-17', 982378, 'Saturnino Mamani', 982378),
(107, '2025-05-17', 328130, 'Jose Chumacero', 328130),
(108, '2025-05-17', 671872, 'Marco Torres', 671872),
(109, '2025-05-17', 298391, 'Esteban Gutierrez', 298391),
(110, '2025-05-18', 765432, 'María Flores', 765432),
(111, '2025-05-18', 671872, 'Marco Torres', 671872),
(112, '2025-05-19', 328130, 'Jose Chumacero', 328130);

CREATE TABLE DETALLEFACTURA
(
	NROFACT INTEGER NOT NULL,
    ID INTEGER NOT NULL,
    CANTIDAD INTEGER NOT NULL,
    PRECIO FLOAT NOT NULL,
    CODIGOPROD VARCHAR(4) NOT NULL,
    PRIMARY KEY(NROFACT,ID),
    FOREIGN KEY(NROFACT) 
    REFERENCES FACTURA(NRO)
		ON DELETE CASCADE
        ON UPDATE CASCADE,
	FOREIGN KEY(CODIGOPROD)
    REFERENCES PRODUCTO(CODIGO)
		ON DELETE CASCADE
        ON UPDATE CASCADE
);

INSERT INTO DETALLEFACTURA (NROFACT, ID, CANTIDAD, PRECIO, CODIGOPROD) VALUES
(101, 1, 2, 5, 'A003'),
(101, 2, 1, 11.5, 'B002'),
(102, 1, 1, 15, 'D003'),
(103, 1, 1, 42, 'A005'),
(104, 1, 6, 1.5, 'B001'),
(104, 2, 4, 4.5, 'B003'),
(105, 1, 1, 183, 'B006'),
(106, 1, 5, 1, 'F001'),
(106, 2, 2, 7, 'D002'),
(107, 1, 1, 10, 'C004'),
(108, 1, 6, 11.5, 'B002'),
(108, 2, 3, 142, 'C001'),
(109, 1, 1, 0.7, 'F003'),
(110, 1, 2, 1, 'F001'),
(110, 2, 1, 75.5, 'E001'),
(111, 1, 10, 2, 'A001'),
(112, 1, 1, 66, 'D001');

SELECT * FROM DETALLEFACTURA;

ALTER TABLE FACTURA
ADD COLUMN MONTOTOTAL FLOAT NOT NULL;

UPDATE FACTURA SET MONTOTOTAL = 21.5 WHERE NRO = 101;
UPDATE FACTURA SET MONTOTOTAL = 15 WHERE NRO = 102;
UPDATE FACTURA SET MONTOTOTAL = 42 WHERE NRO = 103;
UPDATE FACTURA SET MONTOTOTAL = 27 WHERE NRO = 104;
UPDATE FACTURA SET MONTOTOTAL = 183 WHERE NRO = 105;
UPDATE FACTURA SET MONTOTOTAL = 19 WHERE NRO = 106;
UPDATE FACTURA SET MONTOTOTAL = 50 WHERE NRO = 107;
UPDATE FACTURA SET MONTOTOTAL = 211 WHERE NRO = 108;
UPDATE FACTURA SET MONTOTOTAL = 2.1 WHERE NRO = 109;
UPDATE FACTURA SET MONTOTOTAL = 2 WHERE NRO = 110;
UPDATE FACTURA SET MONTOTOTAL = 95.5 WHERE NRO = 111;
UPDATE FACTURA SET MONTOTOTAL = 66 WHERE NRO = 112;


-- Mostrar las facturas de JOSE CHUMACERO
SELECT FACTURA.NRO, FACTURA.FECHA
FROM CLIENTE, FACTURA
WHERE CLIENTE.CI = FACTURA.CICLIENTE
AND CLIENTE.NOMBRE = 'JOSE CHUMACERO';

-- Mostrar la cantidad de facturas de JOSE CHUMACERO
SELECT COUNT(*)
FROM CLIENTE, FACTURA
WHERE CLIENTE.CI = FACTURA.CICLIENTE
AND CLIENTE.NOMBRE = 'JOSE CHUMACERO';

-- Mostrar la cantidad de facturas por cliente
SELECT FACTURA.CICLIENTE, CLIENTE.NOMBRE, COUNT(*) AS CANTIDAD
FROM FACTURA, CLIENTE
WHERE CLIENTE.CI = FACTURA.CICLIENTE
GROUP BY CICLIENTE;

-- Mostrar los clientes que tienen dos o más facturas ( >= 2)
SELECT FACTURA.CICLIENTE, CLIENTE.NOMBRE, COUNT(*)
FROM FACTURA, CLIENTE
WHERE CLIENTE.CI = FACTURA.CICLIENTE
GROUP BY CICLIENTE
HAVING COUNT(*) >= 2; -- es una consulta sobre el resultado

-- Mostrar la cantidad total vendida del producto para el paracetamoL 500MG
SELECT SUM(CANTIDAD)
FROM PRODUCTO, DETALLEFACTURA
WHERE CODIGO=CODIGOPROD 
AND NOMBRE = 'PARACETAMOL 500MG';

-- Mostrar la cantidad total vendida por cada producto
SELECT CODIGOPROD, NOMBRE, SUM(CANTIDAD) AS CANTIDAD
FROM PRODUCTO, DETALLEFACTURA
WHERE  CODIGO=CODIGOPROD 
GROUP BY CODIGOPROD;

-- Mostrar los productos que se han vendido una cantidad total mayor a 5
SELECT CODIGOPROD, NOMBRE, SUM(CANTIDAD) AS CANTIDADMAYORA5
FROM PRODUCTO, DETALLEFACTURA
WHERE  CODIGO=CODIGOPROD 
GROUP BY CODIGOPROD
HAVING SUM(CANTIDAD) > 5;

-- Mostrar la cantidad total comprada de AMOXICILINA500MG por la cliente LUCIA VARGAS
SELECT SUM(CANTIDAD)
FROM CLIENTE, FACTURA, DETALLEFACTURA, PRODUCTO
WHERE CICLIENTE
AND NRO=NROFACT
AND CODIGOPROD=CODIGO
AND CLIENTE.NOMBRE = 'LUCIA VARGAS'
AND PRODUCTO.NOMBRE = 'AMOXICILINA 500MG';

-- Mostrar todos los productos que son de la categoria analgesicos
SELECT ID, NOMBRE
FROM PRODUCTO
WHERE IDCAT IN  (SELECT ID
				FROM CATEGORIA
				WHERE CATEGORIA.IDCAT IN (SELECT ID 
											FROM CATETORIA
											WHERE CATEGORIA.NOMBRE = 'ANALGESICOS'
				)
);

-- Mostrar el monto total vendido por cada producto
SELECT CODIGOPROD, NOMBRE, SUM(CANTIDAD * DETALLEFACTURA.PRECIO) AS MONTOTOTAL
FROM PRODUCTO, DETALLEFACTURA
WHERE CODIGO =CODIGOPROD 
GROUP BY CODIGOPROD
ORDER BY NOMBRE ASC;

SELECT * FROM DETALLEFACTURA;

-- Mostrar los productos que se han vendido más de 1 vez
SELECT PRODUCTO.CODIGO, PRODUCTO.NOMBRE, COUNT(DETALLEFACTURA.CODIGOPROD)
FROM DETALLEFACTURA, PRODUCTO
WHERE DETALLEFACTURA.CODIGOPROD = PRODUCTO.CODIGO
GROUP BY PRODUCTO.CODIGO
HAVING COUNT(DETALLEFACTURA.CODIGOPROD) > 1;

-- generalizacion (abajo hacia arriba)
-- especializacion (arriba hacia abajo)
